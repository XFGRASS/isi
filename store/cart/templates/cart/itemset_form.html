<form id="cart" method="GET" action="{% url 'order:create' %}">
  <input type="hidden" name="hash" id="cart-hash" value="{{ cart_hash }}">
  <table class="table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Unit Price</th>
        <th>Quantity</th>
        <th>Total Price</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
    {% for item in items %}
      <tr class="cart-item
                {% if not item.in_stock %}out-of-stock{% endif %}
                {% if item.off_shelf %}off-shelf{% endif %}"
          data-id="{{ product.instance.pk }}"
          data-url="{% url 'cart_api:item' item.product.pk %}"
          data-price="{{ item.price }}" >
        <td><a href="{% url 'product:detail' item.product.pk %}"
            title="{{ item.name }} - Product Detail">{{ item.name }}</a></td>
        <td><span class="value">${{ item.price }}</span></td>
        <td class="item-quantity"><input type="number" value="{{ item.quantity }}"
                                         min="1" step="1" autocomplete="off"></td>
        <td class="item-total-price">$<span class="value">{{ item.total_price }}</span></td>
        <td>
          <a class="action-delete" href="#"><span class="glyphicon glyphicon-trash"></span>
            Delete
          </a>
          <a class="action-restore" href="#"><span class="glyphicon glyphicon-repeat"></span>
            Restore
          </a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</form>
<p>Total: $<span class="total-price">{{ cart.total_price }}</span></p>

<script>
  // TODO: considering move scripts to a standalone file.
  var $cart = $('#cart');

  // Re-calculate and update the display of total price.
  function updateTotalPrice() {
    var totalPrice = 0;
    $('.cart-item').not('.deleted')
        .find('.item-total-price').children('.value').each(function () {
          totalPrice += parseFloat($(this).text());
    });
    $('span.total-price').text(totalPrice);
  }

  // Changing quantity.
  $cart.find('.item-quantity').children('input').each(function () {
    $(this).change(function () {
      var $item = $(this).parents('.cart-item');
      var quantity = this.value;
      var price = $item.data('price');
      var url = $item.data('url');

      // Re-calculate sub-total price.
      $item.find('.item-total-price').children('.value').text(quantity * price);

      updateTotalPrice();

      // Submit new quantity in several seconds.
      // Avoid submit too frequently when user click continuously.
      var timeout = $item.data('timeout');
      if (timeout != undefined) {
        clearTimeout(timeout);
      }
      timeout = setTimeout(function () {
        $item.removeData('timeout');
        $.ajax({
          url:  url,
          type: 'PUT',
          data: {'quantity': quantity}
        }).done(function (data) {
          $('#cart-hash').val(data.cartHash);
        });
      }, 800);
      $item.data('timeout', timeout);
    });
  });

  // Deleting item.
  $cart.find('a.action-delete').click(function (event) {
    event.preventDefault();
    var $item = $(this).parents('.cart-item');
    var url = $item.data('url');

    $item.addClass('deleted')
         .find('input').attr('disabled', '');
    updateTotalPrice();

    $.ajax({
      url: url,
      type: 'DELETE'
    }).done(function (data) {
      $('#cart-hash').val(data.cartHash);
    });

  });

  // Restoring item.
  $cart.find('a.action-restore').click(function (event) {
    event.preventDefault();
    var $item = $(this).parents('.cart-item');
    var url = $item.data('url');
    var quantity = $item.find('.item-quantity').find('input').val();

    $item.removeClass('deleted')
         .find('input').removeAttr('disabled');
    updateTotalPrice();

    $.ajax({
      url: url,
      type: 'PUT',
      data: {'quantity': quantity}
    }).done(function (data) {
      $('#cart-hash').val(data.cartHash);
    });
  });

  // TODO: Fix quantity inconsistent after page back by user.
</script>